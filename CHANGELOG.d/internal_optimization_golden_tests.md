* Create test machinery for optimizations

  This adds machinery for testing code generation for optimizations.

  Partially extracted from #3915 to add tests for #4205.
