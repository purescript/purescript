language: node_js
node_js:
  - "10"
branches:
  # Only build master and tagged versions, i.e. not feature branches; feature
  # branches already get built after opening a pull request.
  only:
    - master
    - /^v\d+\.\d+(\.\d+)?(-\S*)?$/
matrix:
  include:
    # We use trusty boxes because they seem to be a bit faster.
    - os: linux
      dist: trusty
      sudo: required
      env: BUILD_TYPE=normal DEPLOY=true

    - os: linux
      dist: trusty
      sudo: required
      env: BUILD_TYPE=haddock

    - os: osx
      env: BUILD_TYPE=normal DEPLOY=true

    - os: windows
      env: BUILD_TYPE=normal DEPLOY=true STACK_ROOT=C:/sr RELEASE_KEY=
      # workaround for https://travis-ci.community/t/windows-instances-hanging-before-install/250/15
      # We also zero out the RELEASE_KEY environment variable above to reduce
      # the risk of accidentally leaking it.
      filter_secrets: false
addons:
  apt:
    packages:
    - libgmp-dev
cache:
  directories:
  - $HOME/.local/bin
  - $HOME/.stack
  - C:/sr
  # Maximum amount of time in seconds spent attempting to upload a new cache
  # before aborting. Since our cache can get rather large, increasing this
  # value helps avoid situations where caches fail to be stored. The default
  # value is 180 (at the time of writing).
  timeout: 1000
install:
- |
  if [ "$TRAVIS_OS_NAME" = "windows" ]
  then
    ci/disable-windows-defender.sh
  fi
- mkdir -p "$HOME/.local/bin"
- export PATH="$PATH:$HOME/.local/bin"
- | # Install stack.
  if test ! -f "$HOME/.local/bin/stack"
  then
    URL="https://www.stackage.org/stack/$TRAVIS_OS_NAME-x86_64"
    mkdir "$HOME/stack"
    pushd "$HOME/stack"
    if [ "$TRAVIS_OS_NAME" = "windows" ]
    then
      curl --location "$URL" > stack.zip
      unzip stack.zip
      mv stack.exe "$HOME/.local/bin/"
    else
      curl --location "$URL" > stack.tar.gz
      tar -xzf stack.tar.gz --strip-components=1
      mv stack "$HOME/.local/bin/"
    fi
    popd
  fi
- stack path
- stack --no-terminal setup
- npm install -g bower # for psc-docs / psc-publish tests
- export OS_NAME=$(./ci/convert-os-name.sh)
- |
  if [ -n "$TRAVIS_TAG" ]
  then
    export CI_RELEASE=true
  fi
script:
- ci/build.hs
before_deploy:
- ./bundle/build.sh $OS_NAME
deploy:
  provider: releases
  api_key: $RELEASE_KEY
  file:
    - bundle/$OS_NAME.tar.gz
    - bundle/$OS_NAME.sha
  skip_cleanup: true
  on:
    all_branches: true
    tags: true
    condition: "$DEPLOY = true"
